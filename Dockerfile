# Generated by precisionFDA exporter (v1.0.3) on 2018-06-14 16:17:35 +0000
# The asset download links in this file are valid only for 24h.

# Exported app: gatk-hs37d5decoy-hardfilter, revision: 7, authored by: justin.zook
# https://precision.fda.gov/apps/app-F3gjJfQ0b5k3BZfGFyKFfGB1

# For more information please consult the app export section in the precisionFDA docs

# Start with Ubuntu 14.04 base image
FROM ubuntu:14.04

# Install default precisionFDA Ubuntu packages
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
	aria2 \
	byobu \
	cmake \
	cpanminus \
	curl \
	dstat \
	g++ \
	git \
	htop \
	libboost-all-dev \
	libcurl4-openssl-dev \
	libncurses5-dev \
	make \
	perl \
	pypy \
	python-dev \
	python-pip \
	r-base \
	ruby1.9.3 \
	wget \
	xz-utils

# Install default precisionFDA python packages
RUN pip install \
	requests==2.5.0 \
	futures==2.2.0 \
	setuptools==10.2

# Add DNAnexus repo to apt-get
RUN /bin/bash -c "echo 'deb http://dnanexus-apt-prod.s3.amazonaws.com/ubuntu trusty/amd64/' > /etc/apt/sources.list.d/dnanexus.list"
RUN /bin/bash -c "echo 'deb http://dnanexus-apt-prod.s3.amazonaws.com/ubuntu trusty/all/' >> /etc/apt/sources.list.d/dnanexus.list"
RUN curl https://wiki.dnanexus.com/images/files/ubuntu-signing-key.gpg | apt-key add -

# Install app-specific Ubuntu packages
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
	openjdk-7-jre-headless

# Download app assets
RUN curl https://dl.dnanex.us/F/D/Q858KYGJ5gk1ZVQ2PfFByb3v06X1gZPZZ2PKGvfx/GATK-3.5.tar | tar xf - -C / --no-same-owner --no-same-permissions
RUN curl https://dl.dnanex.us/F/D/GGzqfpX7x10BP9p22XVKGj3qP0XvpBBv1j9Gvfxj/hs37d5-fasta.tar.gz | tar xzf - -C / --no-same-owner --no-same-permissions

# Download helper executables
RUN curl https://dl.dnanex.us/F/D/0K8P4zZvjq9vQ6qV0b6QqY1z2zvfZ0QKQP4gjBXp/emit-1.0.tar.gz | tar xzf - -C /usr/bin/ --no-same-owner --no-same-permissions
RUN curl https://dl.dnanex.us/F/D/bByKQvv1F7BFP3xXPgYXZPZjkXj9V684VPz8gb7p/run-1.2.tar.gz | tar xzf - -C /usr/bin/ --no-same-owner --no-same-permissions

# Write app spec and code to root folder
RUN ["/bin/bash","-c","echo -E \\{\\\"spec\\\":\\{\\\"input_spec\\\":\\[\\{\\\"name\\\":\\\"vcf_in\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"VCF\\ input\\ file\\\",\\\"help\\\":\\\"VCF\\ from\\ GATK\\ with\\ SNPs\\ and\\ indels\\ \\ mapped\\ to\\ GRCh37\\ with\\ decoy\\\"\\}\\],\\\"output_spec\\\":\\[\\{\\\"name\\\":\\\"vcf_out\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"VCF\\ output\\ file\\\",\\\"help\\\":\\\"VCF\\ output\\ file\\ \\\"\\}\\],\\\"internet_access\\\":true,\\\"instance_type\\\":\\\"baseline-2\\\"\\},\\\"assets\\\":\\[\\\"file-BvYzqJQ03vv66X10j8XgG21x\\\",\\\"file-Bk5y43Q0qVb0gjfqY8f9k4g8\\\"\\],\\\"packages\\\":\\[\\\"openjdk-7-jre-headless\\\"\\]\\} \u003e /spec.json"]
RUN ["/bin/bash","-c","echo -E \\{\\\"code\\\":\\\"\\\\n\\\\njava\\ -jar\\ GenomeAnalysisTK.jar\\ \\\\\\\\\\\\n\\ \\ \\ \\ -T\\ SelectVariants\\ \\\\\\\\\\\\n\\ \\ \\ \\ -R\\ hs37d5.fa\\ \\\\\\\\\\\\n\\ \\ \\ \\ -V\\ \\\\\\\"\\$vcf_in_path\\\\\\\"\\ \\\\\\\\\\\\n\\ \\ \\ \\ -selectType\\ SNP\\ \\\\\\\\\\\\n\\ \\ \\ \\ -o\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_snps.vcf\\ \\\\n\\\\njava\\ -jar\\ GenomeAnalysisTK.jar\\ \\\\\\\\\\\\n\\\\t-T\\ VariantFiltration\\ \\\\\\\\\\\\n\\ \\ \\ \\ -R\\ hs37d5.fa\\ \\\\\\\\\\\\n\\ \\ \\ -V\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_snps.vcf\\ \\\\\\\\\\\\n\\ \\ \\ \\ --filterExpression\\ \\\\\\\"QD\\ \\\\u003c\\ 2.0\\ \\|\\|\\ FS\\ \\\\u003e\\ 60.0\\ \\|\\|\\ MQ\\ \\\\u003c\\ 40.0\\ \\|\\|\\ MQRankSum\\ \\\\u003c\\ -12.5\\ \\|\\|\\ ReadPosRankSum\\ \\\\u003c\\ -8.0\\\\\\\"\\ \\\\\\\\\\\\n\\ \\ \\ \\ --filterName\\ \\\\\\\"my_snp_filter\\\\\\\"\\ \\\\\\\\\\\\n\\ \\ -o\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_snps_filt.vcf\\\\n\\\\n\\#grep\\ FILTER\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_snps_filt.vcf\\ \\|\\|\\ echo\\ \\\\\\\"no\\ FILTER\\ lines\\\\\\\"\\\\n\\\\njava\\ -jar\\ GenomeAnalysisTK.jar\\ \\\\\\\\\\\\n\\ \\ \\ \\ -T\\ SelectVariants\\ \\\\\\\\\\\\n\\ \\ \\ \\ -R\\ hs37d5.fa\\ \\\\\\\\\\\\n\\ \\ \\ \\ -V\\ \\\\\\\"\\$vcf_in_path\\\\\\\"\\ \\\\\\\\\\\\n\\ \\ \\ \\ -selectType\\ INDEL\\ \\\\\\\\\\\\n\\ \\ \\ \\ -o\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_indels.vcf\\ \\\\n\\\\njava\\ -jar\\ GenomeAnalysisTK.jar\\ \\\\\\\\\\\\n\\ \\ \\ \\ -T\\ VariantFiltration\\ \\\\\\\\\\\\n\\ \\ \\ \\ -R\\ hs37d5.fa\\ \\\\\\\\\\\\n\\ \\ \\ \\ -V\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_indels.vcf\\ \\\\\\\\\\\\n\\ \\ \\ \\ --filterExpression\\ \\\\\\\"QD\\ \\\\u003c\\ 2.0\\ \\|\\|\\ FS\\ \\\\u003e\\ 200.0\\ \\|\\|\\ ReadPosRankSum\\ \\\\u003c\\ -20.0\\\\\\\"\\ \\\\\\\\\\\\n\\ \\ \\ \\ --filterName\\ \\\\\\\"my_indel_filter\\\\\\\"\\ \\\\\\\\\\\\n\\ \\ \\ \\ -o\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_indels_filt.vcf\\ \\\\n\\ \\ \\ \\ \\\\n\\#grep\\ FILTER\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_indels_filt.vcf\\ \\|\\|\\ echo\\ \\\\\\\"no\\ FILTER\\ lines\\\\\\\"\\\\n\\\\njava\\ -jar\\ GenomeAnalysisTK.jar\\ \\ \\\\\\\\\\\\n\\ \\ \\ \\ -T\\ CombineVariants\\ \\\\\\\\\\\\n\\ \\ \\ \\ -R\\ hs37d5.fa\\ \\\\\\\\\\\\n\\ \\ \\ \\ -V\\ \\ \\\\\\\"\\$vcf_in_path\\\\\\\"_snps_filt.vcf\\ \\\\\\\\\\\\n\\ \\ \\ \\ -V\\ \\ \\\\\\\"\\$vcf_in_path\\\\\\\"_indels_filt.vcf\\ \\\\\\\\\\\\n\\ \\ \\ \\ -o\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_filt.vcf\\ \\\\\\\\\\\\n\\ \\ \\ \\ --assumeIdenticalSamples\\\\n\\ \\\\n\\ \\ \\ \\ \\ \\\\nemit\\ vcf_out\\ \\\\\\\"\\$vcf_in_path\\\\\\\"_filt.vcf\\\"\\} | python -c 'import sys,json; print json.load(sys.stdin)[\"code\"]' \u003e /script.sh"]

# Create directory /work and set it to $HOME and CWD
RUN mkdir -p /work
ENV HOME="/work"
WORKDIR /work

# Set entry point to container
ENTRYPOINT ["/usr/bin/run"]

VOLUME /data
VOLUME /work